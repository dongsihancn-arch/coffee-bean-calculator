<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咖啡豆核价计算器</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #8B4513;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #D2B48C;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 5px solid #8B4513;
        }
        h2 {
            color: #8B4513;
            margin-top: 0;
            margin-bottom: 20px;
        }
        h3 {
            color: #A0522D;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #D2B48C;
        }
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-field {
            flex: 1 1 200px;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #5D4037;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.1);
        }
        button {
            background-color: #8B4513;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #6d3710;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 40px;
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #5D4037;
        }
        .summary {
            background-color: #f5e9dc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
        }
        .summary h3 {
            margin-top: 0;
            color: #8B4513;
        }
        .add-bean-btn {
            background-color: #4CAF50;
            margin-left: 10px;
        }
        .remove-bean-btn {
            background-color: #f44336;
            margin-left: 5px;
        }
        .config-options {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        .config-section {
            flex: 1;
            min-width: 300px;
        }
        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .ratio-validation {
            margin-top: 15px;
            padding: 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
        }
        .ratio-valid {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }
        .ratio-invalid {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .result-label {
            font-weight: bold;
            color: #5D4037;
        }
        .result-value {
            color: #8B4513;
            font-weight: bold;
            font-size: 16px;
        }
        .highlight {
            background-color: #fff3e0;
            font-weight: bold;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border-left: 5px solid #FF9800;
        }
        .bean-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .bean-row:hover {
            background-color: #f9f9f9;
        }
        .bean-input {
            flex: 1;
            min-width: 180px;
        }
        .instructions {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 14px;
        }
        .history-section {
            margin-top: 40px;
        }
        .history-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .save-btn {
            background-color: #4CAF50;
        }
        .export-btn {
            background-color: #2196F3;
        }
        .clear-btn {
            background-color: #f44336;
        }
        .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .no-history {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        .image-btn {
            background-color: #9C27B0;
        }
        .restore-btn {
            background-color: #FF9800;
        }
        
        /* 图片生成选项样式 */
        .image-options {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .image-option-item {
            margin-bottom: 10px;
        }
        
        .image-option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .image-option-label {
            display: inline-block;
            font-weight: bold;
            color: #5D4037;
            margin-right: 15px;
        }
        
        .image-option-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* 隐藏生豆单价选项样式 */
        .hide-price-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .hide-price-label {
            font-weight: bold;
            color: #5D4037;
            margin-right: 8px;
        }
        
        .hide-price-checkbox {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        
        .hide-price-spacer {
            display: inline-block;
            width: 20px;
        }
        
        /* 导航标签样式 */
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #8B4513;
            margin-bottom: 30px;
        }
        
        .nav-tab {
            padding: 12px 30px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-weight: bold;
            color: #5D4037;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
        }
        
        .nav-tab:hover {
            background-color: #eee;
        }
        
        .nav-tab.active {
            background-color: #8B4513;
            color: white;
            border-color: #8B4513;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 历史记录操作按钮样式 */
        .history-actions-cell {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
        
        .history-action-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            min-width: 60px;
        }
        
        /* 隐藏的表格容器，用于生成图片 */
        #table-for-image {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 600px;
            padding: 20px;
            background-color: white;
            border: 2px solid #8B4513;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .table-header {
            text-align: center;
            color: #8B4513;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #D2B48C;
        }
        
        .table-row {
            display: flex;
            margin-bottom: 10px;
        }
        
        .table-label {
            flex: 1;
            font-weight: bold;
            color: #5D4037;
        }
        
        .table-value {
            flex: 2;
            color: #8B4513;
        }
        
        .bean-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .bean-table th {
            background-color: #8B4513;
            color: white;
            padding: 8px;
        }
        
        .bean-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        
        .bean-table tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        .generated-table {
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        .table-remark {
            margin-top: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #8B4513;
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>咖啡豆核价计算器</h1>
        
        <!-- 导航标签 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="calculator">核价计算器</div>
            <div class="nav-tab" data-tab="history">历史记录</div>
        </div>
        
        <!-- 核价计算器标签页 -->
        <div id="calculator-tab" class="tab-content active">
            <!-- 1. 产品基本信息 -->
            <div class="section">
                <h2>产品基本信息</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label for="product-name">产品名称</label>
                        <input type="text" id="product-name" placeholder="请输入产品名称">
                    </div>
                    <div class="input-field">
                        <label for="business-owner">业务归属</label>
                        <input type="text" id="business-owner" placeholder="请输入业务归属（如部门/人员）">
                    </div>
                </div>
            </div>
            
            <!-- 2. 产品规格信息 -->
            <div class="section">
                <h2>产品规格信息</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label for="package-weight">包装规格 (g/袋)</label>
                        <input type="number" id="package-weight" value="500" min="1">
                    </div>
                    <div class="input-field">
                        <label for="bags-per-box">每箱装袋数</label>
                        <input type="number" id="bags-per-box" value="20" min="1">
                    </div>
                </div>
            </div>
            
            <!-- 3. 生豆信息配置 -->
            <div class="section">
                <h2>生豆信息配置</h2>
                <div id="beans-container">
                    <!-- 生豆信息将动态添加 -->
                </div>
                <div class="input-group">
                    <div class="input-field">
                        <button id="add-bean" class="add-bean-btn">添加咖啡豆种类</button>
                    </div>
                </div>
                <div id="ratio-validation" class="ratio-validation"></div>
            </div>
            
            <div class="section">
                <h2>生转熟损耗率</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label for="roasting-loss">生转熟损耗率 (小数形式，如0.8表示80%)</label>
                        <input type="number" id="roasting-loss" value="0.8" step="0.01" min="0.1" max="1">
                        <div class="instructions">注：0.8表示1公斤生豆可得到0.8公斤熟豆，损耗20%</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>成本参数配置</h2>
                <div class="config-options">
                    <div class="config-section">
                        <h3>包材成本</h3>
                        <div class="input-field">
                            <label for="bag-cost">包袋成本 (元/袋)</label>
                            <input type="number" id="bag-cost" value="1.2" step="0.01" min="0">
                        </div>
                        <div class="input-field">
                            <label for="sticker-cost">贴纸成本 (元/袋)</label>
                            <input type="number" id="sticker-cost" value="0.3" step="0.01" min="0">
                        </div>
                        <div class="input-field">
                            <label for="box-cost">纸箱成本 (元/箱)</label>
                            <input type="number" id="box-cost" value="3.8" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h3>加工与能耗成本</h3>
                        <div class="input-field">
                            <label for="raw-bean-energy-cost">生豆烘焙能耗 (元/公斤)</label>
                            <input type="number" id="raw-bean-energy-cost" value="2.5" step="0.01" min="0">
                        </div>
                        <div class="input-field">
                            <label for="packaging-labor">包装人工费 (元/袋)</label>
                            <input type="number" id="packaging-labor" value="0.5" step="0.01" min="0">
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h3>运输及其他</h3>
                        <div class="input-field">
                            <label for="transport-cost">运费单价 (元/公斤)</label>
                            <input type="number" id="transport-cost" value="0.5" step="0.01" min="0">
                        </div>
                        <div class="input-field">
                            <label for="vat-rate">对外开票税率 (%)</label>
                            <input type="number" id="vat-rate" value="13" step="0.1" min="0">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>毛利率与报价设置</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label for="target-margin">目标毛利率 (%)</label>
                        <input type="number" id="target-margin" value="20" step="0.1" min="0" max="100">
                    </div>
                    <div class="input-field">
                        <label for="external-price">对外报价 (元/袋)</label>
                        <input type="number" id="external-price" step="0.01" min="0">
                    </div>
                </div>
                <div class="instructions">注：可以输入目标毛利率计算对外报价，也可以输入对外报价反算毛利率</div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="calculate-by-margin" style="margin-right: 15px;">通过毛利率计算报价</button>
                <button id="calculate-by-price" style="background-color: #2196F3;">通过报价计算毛利率</button>
            </div>
            
            <div id="results" class="results">
                <h2>核价结果</h2>
                
                <div class="summary">
                    <h3>成本与定价明细</h3>
                    <div id="pricing-results"></div>
                </div>
                
                <div class="summary">
                    <h3>增值税明细</h3>
                    <div id="vat-details"></div>
                </div>
                
                <div class="summary highlight">
                    <h3>盈利能力分析</h3>
                    <div id="profit-analysis"></div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="save-result" class="save-btn" style="display: none; margin-right: 15px;">保存当前计算结果</button>
                    <button id="generate-image" class="image-btn" style="display: none;">生成表格图片</button>
                </div>
                
                <div id="image-options" class="image-options" style="display: none;">
                    <h3>图片生成选项</h3>
                    <div class="hide-price-option">
                        <span class="hide-price-label">隐藏生豆单价</span>
                        <input type="checkbox" id="hide-bean-price" class="hide-price-checkbox" checked>
                        <span class="hide-price-spacer"></span>
                    </div>
                    <div class="image-option-item">
                        <label for="image-remark" class="image-option-label">备注信息：</label>
                        <textarea id="image-remark" class="image-option-input" placeholder="请输入备注信息（选填）" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 历史记录标签页 -->
        <div id="history-tab" class="tab-content">
            <div class="section">
                <h2>历史记录</h2>
                <div class="history-actions">
                    <button id="export-history" class="export-btn">导出历史记录为Excel</button>
                    <button id="clear-history" class="clear-btn">清空历史记录</button>
                </div>
                <div class="history-table-container">
                    <table id="history-table">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>业务归属</th>
                                <th>生豆构成</th>
                                <th>生豆成本(元/kg)</th>
                                <th>包材成本(元/袋)</th>
                                <th>对外报价(元/袋)</th>
                                <th>毛利率</th>
                                <th>保存时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <!-- 历史记录将动态添加 -->
                        </tbody>
                    </table>
                    <div id="no-history" class="no-history">暂无历史记录</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>咖啡豆核价计算器 v1.0 | 基于专业成本核算模型</p>
        </div>
    </div>

    <!-- 隐藏的表格容器，用于生成图片 -->
    <div id="table-for-image" style="display: none;">
        <div class="generated-table">
            <div class="table-header">咖啡豆产品信息表</div>
            
            <div class="table-row">
                <div class="table-label">产品名称：</div>
                <div class="table-value" id="img-product-name">-</div>
            </div>
            
            <div class="table-row">
                <div class="table-label">业务归属：</div>
                <div class="table-value" id="img-business-owner">-</div>
            </div>
            
            <div class="table-row">
                <div class="table-label">产品规格：</div>
                <div class="table-value" id="img-product-spec">-</div>
            </div>
            
            <div class="table-row">
                <div class="table-label">对外报价：</div>
                <div class="table-value" id="img-external-price">-</div>
            </div>
            
            <div style="margin-top: 15px;">
                <div style="font-weight: bold; color: #5D4037; margin-bottom: 8px;">咖啡生豆配比：</div>
                <table class="bean-table" id="img-bean-table">
                    <thead id="img-bean-thead">
                        <tr>
                            <th>生豆名称</th>
                            <th class="bean-price-column">单价(元/公斤)</th>
                            <th>配比(%)</th>
                        </tr>
                    </thead>
                    <tbody id="img-bean-tbody">
                        <!-- 生豆信息将动态添加 -->
                    </tbody>
                </table>
            </div>
            
            <div id="img-remark-container" style="display: none;">
                <div style="font-weight: bold; color: #5D4037; margin-top: 15px; margin-bottom: 8px;">备注：</div>
                <div class="table-remark" id="img-remark-text">-</div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
                生成时间：<span id="img-generation-time">-</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // 初始化咖啡豆数据 - 始终保留至少一组
        let beans = [
            {id: 'bean-default-1', name: '云南水洗二级', price: 58.57, ratio: 100}
        ];
        
        let calculationMode = 'marginToPrice'; // 默认模式：通过毛利率计算报价
        let currentResults = null; // 当前计算结果
        
        // 从本地存储加载历史记录
        let history = JSON.parse(localStorage.getItem('coffee_bean_history')) || [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 添加导航标签事件监听器
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // 添加事件监听器
            document.getElementById('add-bean').addEventListener('click', function() {
                addBean('新咖啡豆', 50, 0);
            });
            
            document.getElementById('calculate-by-margin').addEventListener('click', function() {
                setCalculationMode('marginToPrice');
                calculatePricing();
            });
            
            document.getElementById('calculate-by-price').addEventListener('click', function() {
                setCalculationMode('priceToMargin');
                calculatePricing();
            });
            
            document.getElementById('save-result').addEventListener('click', saveCurrentResult);
            document.getElementById('generate-image').addEventListener('click', generateTableImage);
            document.getElementById('export-history').addEventListener('click', exportHistoryToExcel);
            document.getElementById('clear-history').addEventListener('click', clearHistory);
            
            // 为所有输入框添加输入事件监听器，以便在修改参数后允许重新计算
            setupInputChangeListeners();
            
            // 初始化显示
            updateBeansDisplay();
            updateRatioValidation();
            
            // 加载历史记录
            loadHistory();
        });
        
        // 切换标签页
        function switchTab(tabId) {
            // 更新导航标签状态
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // 更新内容标签页
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        // 设置输入框变化监听器
        function setupInputChangeListeners() {
            // 监听所有输入框的变化
            const allInputs = document.querySelectorAll('input');
            allInputs.forEach(input => {
                // 移除之前的change事件监听器（如果有的话）
                input.removeEventListener('change', enableCalculationButtons);
                // 添加新的change事件监听器
                input.addEventListener('change', enableCalculationButtons);
                // 添加input事件监听器，实现实时响应
                input.addEventListener('input', enableCalculationButtons);
            });
        }
        
        // 启用计算按钮
        function enableCalculationButtons() {
            // 确保计算按钮始终可用
            document.getElementById('calculate-by-margin').disabled = false;
            document.getElementById('calculate-by-price').disabled = false;
            
            // 确保输入框始终可用
            document.getElementById('target-margin').disabled = false;
            document.getElementById('external-price').disabled = false;
            
            // 更新计算模式占位符
            updatePlaceholders();
        }
        
        // 更新占位符
        function updatePlaceholders() {
            const marginInput = document.getElementById('target-margin');
            const priceInput = document.getElementById('external-price');
            
            if (calculationMode === 'marginToPrice') {
                marginInput.placeholder = '输入目标毛利率';
                priceInput.placeholder = '系统自动计算';
            } else {
                marginInput.placeholder = '系统自动计算';
                priceInput.placeholder = '输入对外报价';
            }
        }
        
        // 设置计算模式
        function setCalculationMode(mode) {
            calculationMode = mode;
            updatePlaceholders();
        }
        
        // 添加咖啡豆函数
        function addBean(name, price, ratio) {
            const beanId = 'bean-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            beans.push({id: beanId, name: name, price: price, ratio: ratio});
            
            updateBeansDisplay();
            updateRatioValidation();
        }
        
        // 移除咖啡豆函数
        function removeBean(beanId) {
            if (beans.length <= 1) {
                alert("至少需要保留一种咖啡豆！");
                return;
            }
            
            beans = beans.filter(bean => bean.id !== beanId);
            updateBeansDisplay();
            updateRatioValidation();
        }
        
        // 更新咖啡豆显示
        function updateBeansDisplay() {
            const container = document.getElementById('beans-container');
            container.innerHTML = '';
            
            beans.forEach((bean, index) => {
                const beanDiv = document.createElement('div');
                beanDiv.className = 'bean-row';
                beanDiv.innerHTML = `
                    <div class="bean-input">
                        <label>咖啡豆${index+1}名称</label>
                        <input type="text" class="bean-name" value="${bean.name || ''}" data-id="${bean.id}">
                    </div>
                    <div class="bean-input">
                        <label>单价 (元/公斤)</label>
                        <input type="number" class="bean-price" value="${bean.price || 0}" step="0.01" min="0" data-id="${bean.id}">
                    </div>
                    <div class="bean-input">
                        <label>配比 (%)</label>
                        <input type="number" class="bean-ratio" value="${bean.ratio || 0}" step="1" min="0" max="100" data-id="${bean.id}">
                    </div>
                    <div class="bean-input">
                        <label>操作</label>
                        <button class="remove-bean-btn" data-id="${bean.id}">移除</button>
                    </div>
                `;
                container.appendChild(beanDiv);
            });
            
            // 重新绑定事件监听器
            bindBeanEvents();
        }
        
        // 绑定生豆相关事件
        function bindBeanEvents() {
            // 名称输入
            document.querySelectorAll('.bean-name').forEach(input => {
                input.addEventListener('input', function() {
                    const beanId = this.getAttribute('data-id');
                    const bean = beans.find(b => b.id === beanId);
                    if (bean) {
                        bean.name = this.value;
                    }
                });
            });
            
            // 单价输入 - 修复小数输入问题
            document.querySelectorAll('.bean-price').forEach(input => {
                // 移除之前的事件监听器
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                // 添加新的事件监听器
                newInput.addEventListener('input', function() {
                    const beanId = this.getAttribute('data-id');
                    const bean = beans.find(b => b.id === beanId);
                    if (bean) {
                        // 允许小数输入
                        bean.price = parseFloat(this.value) || 0;
                    }
                });
                
                newInput.addEventListener('blur', function() {
                    const beanId = this.getAttribute('data-id');
                    const bean = beans.find(b => b.id === beanId);
                    if (bean) {
                        bean.price = parseFloat(this.value) || 0;
                    }
                });
            });
            
            // 配比输入
            document.querySelectorAll('.bean-ratio').forEach(input => {
                input.addEventListener('input', function() {
                    const beanId = this.getAttribute('data-id');
                    const bean = beans.find(b => b.id === beanId);
                    if (bean) {
                        let value = parseInt(this.value) || 0;
                        if (value < 0) value = 0;
                        if (value > 100) value = 100;
                        
                        bean.ratio = value;
                        this.value = value;
                        
                        updateRatioValidation();
                    }
                });
                
                input.addEventListener('blur', function() {
                    const beanId = this.getAttribute('data-id');
                    const bean = beans.find(b => b.id === beanId);
                    if (bean) {
                        let value = parseInt(this.value) || 0;
                        if (value < 0) value = 0;
                        if (value > 100) value = 100;
                        
                        bean.ratio = value;
                        this.value = value;
                        
                        updateRatioValidation();
                    }
                });
            });
            
            // 移除按钮
            document.querySelectorAll('.remove-bean-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const beanId = this.getAttribute('data-id');
                    removeBean(beanId);
                });
            });
        }
        
        // 更新比例验证显示
        function updateRatioValidation() {
            const totalRatio = beans.reduce((sum, bean) => {
                return sum + parseFloat(bean.ratio || 0);
            }, 0);
            
            const validationDiv = document.getElementById('ratio-validation');
            
            // 使用更精确的比较，允许0.1的误差
            if (Math.abs(totalRatio - 100) < 0.1) {
                validationDiv.textContent = `配方配比总和: ${totalRatio.toFixed(1)}% - 正确`;
                validationDiv.className = 'ratio-validation ratio-valid';
            } else {
                validationDiv.textContent = `配方配比总和: ${totalRatio.toFixed(1)}% - 错误，必须等于100%`;
                validationDiv.className = 'ratio-validation ratio-invalid';
            }
        }
        
        // 计算核价
        function calculatePricing() {
            // 检查配方配比总和是否为100%
            const totalRatio = beans.reduce((sum, bean) => {
                return sum + parseFloat(bean.ratio || 0);
            }, 0);
            
            if (Math.abs(totalRatio - 100) > 0.1) {
                alert(`配方配比总和为 ${totalRatio.toFixed(1)}%，必须等于100%才能计算核价。`);
                return;
            }
            
            // 获取所有输入值
            const productName = document.getElementById('product-name').value || '未命名产品';
            const businessOwner = document.getElementById('business-owner').value || '';
            const packageWeight = parseFloat(document.getElementById('package-weight').value) || 0;
            const roastingLoss = parseFloat(document.getElementById('roasting-loss').value) || 0.8;
            const bagsPerBox = parseFloat(document.getElementById('bags-per-box').value) || 0;
            const bagCost = parseFloat(document.getElementById('bag-cost').value) || 0;
            const stickerCost = parseFloat(document.getElementById('sticker-cost').value) || 0;
            const boxCost = parseFloat(document.getElementById('box-cost').value) || 0;
            const rawBeanEnergyCost = parseFloat(document.getElementById('raw-bean-energy-cost').value) || 0;
            const packagingLabor = parseFloat(document.getElementById('packaging-labor').value) || 0;
            const transportCost = parseFloat(document.getElementById('transport-cost').value) || 0;
            const vatRate = parseFloat(document.getElementById('vat-rate').value) || 0;
            const targetMarginInput = parseFloat(document.getElementById('target-margin').value) || 0;
            const externalPriceInput = parseFloat(document.getElementById('external-price').value) || 0;
            
            // 获取当前生豆构成
            const beanComposition = beans.map(bean => ({
                name: bean.name || '',
                price: bean.price || 0,
                ratio: bean.ratio || 0
            }));
            
            // 计算生豆平均成本
            let rawBeanCost = 0;
            beans.forEach(bean => {
                rawBeanCost += ((bean.price || 0) * (bean.ratio || 0)) / 100;
            });
            
            // 计算熟豆成本 (考虑生转熟损耗)
            const roastedBeanCostPerKg = roastingLoss > 0 ? rawBeanCost / roastingLoss : 0;
            
            // 计算每袋熟豆成本
            const roastedBeanCostPerBag = roastedBeanCostPerKg * (packageWeight / 1000);
            
            // 计算熟豆烘焙能耗 (生豆烘焙能耗 / 损耗率)
            const roastedBeanEnergyCostPerKg = roastingLoss > 0 ? rawBeanEnergyCost / roastingLoss : 0;
            
            // 计算每袋烘焙能耗成本
            const energyCostPerBag = roastedBeanEnergyCostPerKg * (packageWeight / 1000);
            
            // 计算纸箱分摊成本
            const boxCostPerBag = bagsPerBox > 0 ? boxCost / bagsPerBox : 0;
            
            // 计算包材总成本
            const packagingCost = bagCost + stickerCost + boxCostPerBag;
            
            // 计算每袋运输成本
            const transportCostPerBag = transportCost * (packageWeight / 1000);
            
            // 计算原物料成本
            const materialCost = roastedBeanCostPerBag + packagingCost;
            
            // 计算不含能耗和人工的成本
            const costWithoutEnergyLabor = materialCost + transportCostPerBag;
            
            // 计算含能耗和人工的成本
            const costWithEnergyLabor = costWithoutEnergyLabor + energyCostPerBag + packagingLabor;
            
            let targetMargin, recommendedPrice;
            
            // 根据计算模式确定目标毛利率和对外报价
            if (calculationMode === 'marginToPrice') {
                // 通过毛利率计算报价
                targetMargin = targetMarginInput;
                if (targetMargin >= 100) {
                    alert("目标毛利率不能大于或等于100%");
                    return;
                }
                if (targetMargin < 100) {
                    recommendedPrice = costWithEnergyLabor / (1 - targetMargin/100);
                } else {
                    recommendedPrice = 0;
                }
                // 更新对外报价输入框
                document.getElementById('external-price').value = recommendedPrice.toFixed(2);
            } else {
                // 通过报价计算毛利率
                recommendedPrice = externalPriceInput;
                if (recommendedPrice > 0) {
                    targetMargin = ((recommendedPrice - costWithEnergyLabor) / recommendedPrice) * 100;
                    // 更新目标毛利率输入框
                    document.getElementById('target-margin').value = targetMargin.toFixed(2);
                } else {
                    targetMargin = 0;
                }
            }
            
            // 计算增值税
            // 进项税 = 不含能耗和人工成本/(1+增值税率)*增值税率 + 熟豆烘焙能耗费/1.09 * 0.09 + 运输成本/1.06 * 0.06
            const inputVat1 = vatRate > 0 ? costWithoutEnergyLabor / (1 + vatRate/100) * (vatRate/100) : 0;
            const inputVat2 = energyCostPerBag / 1.09 * 0.09;  // 能耗服务税率9%
            const inputVat3 = transportCostPerBag / 1.06 * 0.06; // 运输服务税率6%
            const totalInputVat = inputVat1 + inputVat2 + inputVat3;
            
            // 销项税 = 对外报价/(1+增值税率)*增值税率
            const outputVat = vatRate > 0 ? recommendedPrice / (1 + vatRate/100) * (vatRate/100) : 0;
            
            // 实际增值税成本
            const actualVatCost = outputVat - totalInputVat;
            
            // 每袋税后毛利
            const profitAfterTax = recommendedPrice - costWithEnergyLabor - actualVatCost;
            
            // 每公斤税后毛利
            const profitAfterTaxPerKg = packageWeight > 0 ? (profitAfterTax / packageWeight) * 1000 : 0;
            
            // 税后毛利率
            const profitMarginAfterTax = recommendedPrice > 0 ? (profitAfterTax / recommendedPrice) * 100 : 0;
            
            // 保存当前计算结果
            currentResults = {
                // 输入参数
                inputParams: {
                    productName: productName,
                    businessOwner: businessOwner,
                    packageWeight: packageWeight,
                    roastingLoss: roastingLoss,
                    bagsPerBox: bagsPerBox,
                    bagCost: bagCost,
                    stickerCost: stickerCost,
                    boxCost: boxCost,
                    rawBeanEnergyCost: rawBeanEnergyCost,
                    packagingLabor: packagingLabor,
                    transportCost: transportCost,
                    vatRate: vatRate,
                    targetMargin: targetMarginInput,
                    externalPrice: externalPriceInput,
                    calculationMode: calculationMode
                },
                
                // 生豆构成
                beanComposition: beanComposition,
                
                // 计算结果
                productName: productName,
                businessOwner: businessOwner,
                packageWeight: packageWeight,
                bagsPerBox: bagsPerBox,
                rawBeanCost: rawBeanCost,
                roastedBeanCostPerBag: roastedBeanCostPerBag,
                packagingCost: packagingCost,
                energyCostPerBag: energyCostPerBag,
                packagingLabor: packagingLabor,
                transportCostPerBag: transportCostPerBag,
                costWithoutEnergyLabor: costWithoutEnergyLabor,
                costWithEnergyLabor: costWithEnergyLabor,
                targetMargin: targetMargin,
                recommendedPrice: recommendedPrice,
                profitAfterTax: profitAfterTax,
                profitAfterTaxPerKg: profitAfterTaxPerKg,
                profitMarginAfterTax: profitMarginAfterTax,
                totalInputVat: totalInputVat,
                outputVat: outputVat,
                actualVatCost: actualVatCost
            };
            
            // 显示结果
            document.getElementById('results').style.display = 'block';
            document.getElementById('save-result').style.display = 'inline-block';
            document.getElementById('generate-image').style.display = 'inline-block';
            document.getElementById('image-options').style.display = 'block';
            
            // 更新成本与定价明细
            document.getElementById('pricing-results').innerHTML = `
                <div class="result-item">
                    <span class="result-label">产品名称:</span>
                    <span class="result-value">${productName}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">业务归属:</span>
                    <span class="result-value">${businessOwner || '未设置'}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">生豆平均成本:</span>
                    <span class="result-value">${rawBeanCost.toFixed(2)} 元/公斤</span>
                </div>
                <div class="result-item">
                    <span class="result-label">熟豆成本:</span>
                    <span class="result-value">${roastedBeanCostPerBag.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">熟豆烘焙能耗:</span>
                    <span class="result-value">${energyCostPerBag.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">包材成本:</span>
                    <span class="result-value">${packagingCost.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">包装人工:</span>
                    <span class="result-value">${packagingLabor.toFixed(3)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">运输成本:</span>
                    <span class="result-value">${transportCostPerBag.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">不含能耗和人工成本:</span>
                    <span class="result-value">${costWithoutEnergyLabor.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">含能耗和人工成本:</span>
                    <span class="result-value">${costWithEnergyLabor.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">目标毛利率:</span>
                    <span class="result-value">${targetMargin.toFixed(2)}%</span>
                </div>
                <div class="result-item">
                    <span class="result-label">对外报价:</span>
                    <span class="result-value">${recommendedPrice.toFixed(2)} 元/袋</span>
                </div>
            `;
            
            // 更新增值税明细
            document.getElementById('vat-details').innerHTML = `
                <div class="result-item">
                    <span class="result-label">进项税合计:</span>
                    <span class="result-value">${totalInputVat.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">销项税:</span>
                    <span class="result-value">${outputVat.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">实际增值税成本:</span>
                    <span class="result-value">${actualVatCost.toFixed(4)} 元/袋</span>
                </div>
            `;
            
            // 更新盈利能力分析
            document.getElementById('profit-analysis').innerHTML = `
                <div class="result-item">
                    <span class="result-label">每袋税后毛利:</span>
                    <span class="result-value">${profitAfterTax.toFixed(4)} 元/袋</span>
                </div>
                <div class="result-item">
                    <span class="result-label">每公斤税后毛利:</span>
                    <span class="result-value">${profitAfterTaxPerKg.toFixed(2)} 元/公斤</span>
                </div>
                <div class="result-item">
                    <span class="result-label">税后毛利率:</span>
                    <span class="result-value">${profitMarginAfterTax.toFixed(2)}%</span>
                </div>
            `;
        }
        
        // 保存当前结果
        function saveCurrentResult() {
            if (!currentResults) {
                alert("没有可保存的结果，请先进行计算！");
                return;
            }
            
            const timestamp = new Date().toLocaleString('zh-CN');
            const historyRecord = {
                id: Date.now(),
                timestamp: timestamp,
                ...currentResults
            };
            
            history.push(historyRecord);
            localStorage.setItem('coffee_bean_history', JSON.stringify(history));
            
            loadHistory();
            alert("计算结果已保存到历史记录！");
        }
        
        // 从历史记录调回数据
        function restoreFromHistory(historyRecord) {
            // 清空当前生豆数据
            beans = [];
            
            // 添加生豆数据
            if (historyRecord.beanComposition && historyRecord.beanComposition.length > 0) {
                // 直接构建beans数组
                historyRecord.beanComposition.forEach(bean => {
                    const beanId = 'bean-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    beans.push({
                        id: beanId,
                        name: bean.name || '',
                        price: bean.price || 0,
                        ratio: bean.ratio || 0
                    });
                });
            } else {
                // 如果没有生豆数据，添加默认的一组
                beans = [
                    {id: 'bean-default-1', name: '云南水洗二级', price: 58.57, ratio: 100}
                ];
            }
            
            // 更新显示
            updateBeansDisplay();
            
            // 填充所有输入参数
            if (historyRecord.inputParams) {
                const params = historyRecord.inputParams;
                
                // 填充产品基本信息
                document.getElementById('product-name').value = params.productName || '';
                document.getElementById('business-owner').value = params.businessOwner || '';
                
                // 填充产品规格设置
                document.getElementById('package-weight').value = params.packageWeight || 0;
                document.getElementById('bags-per-box').value = params.bagsPerBox || 0;
                
                // 填充生转熟损耗率
                document.getElementById('roasting-loss').value = params.roastingLoss || 0.8;
                
                // 填充包材成本配置
                document.getElementById('bag-cost').value = params.bagCost || 0;
                document.getElementById('sticker-cost').value = params.stickerCost || 0;
                document.getElementById('box-cost').value = params.boxCost || 0;
                
                // 填充能耗与加工成本
                document.getElementById('raw-bean-energy-cost').value = params.rawBeanEnergyCost || 0;
                document.getElementById('packaging-labor').value = params.packagingLabor || 0;
                document.getElementById('transport-cost').value = params.transportCost || 0;
                document.getElementById('vat-rate').value = params.vatRate || 0;
                
                // 填充毛利率设置
                document.getElementById('target-margin').value = params.targetMargin || 0;
                document.getElementById('external-price').value = params.externalPrice || 0;
                
                // 设置计算模式
                if (params.calculationMode) {
                    setCalculationMode(params.calculationMode);
                } else {
                    setCalculationMode('marginToPrice');
                }
            }
            
            // 切换到计算器标签页
            switchTab('calculator');
            
            // 启用计算按钮
            enableCalculationButtons();
            
            // 自动计算
            calculatePricing();
            
            // 滚动到顶部
            window.scrollTo(0, 0);
            
            alert("历史记录已完整调回到当前计算页面，可以调整参数后重新计算！");
        }
        
        // 生成表格图片
        function generateTableImage() {
            if (!currentResults) {
                alert("没有可用的计算结果，请先进行计算！");
                return;
            }
            
            // 获取图片生成选项
            const hideBeanPrice = document.getElementById('hide-bean-price').checked;
            const remark = document.getElementById('image-remark').value || '';
            
            // 更新图片表格中的信息
            document.getElementById('img-product-name').textContent = currentResults.productName || '咖啡豆产品';
            document.getElementById('img-business-owner').textContent = currentResults.businessOwner || '未设置';
            
            // 产品规格 = 包装规格 (g/袋) + 每箱装袋数 (袋/箱)
            const productSpec = `${currentResults.packageWeight}g/袋，${currentResults.bagsPerBox}袋/箱`;
            document.getElementById('img-product-spec').textContent = productSpec;
            
            document.getElementById('img-external-price').textContent = `${currentResults.recommendedPrice.toFixed(2)} 元/袋`;
            
            // 更新生豆配比表格
            const thead = document.getElementById('img-bean-thead');
            const tbody = document.getElementById('img-bean-tbody');
            
            // 根据是否隐藏生豆单价更新表头
            if (hideBeanPrice) {
                thead.innerHTML = `
                    <tr>
                        <th>生豆名称</th>
                        <th>配比(%)</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>生豆名称</th>
                        <th class="bean-price-column">单价(元/公斤)</th>
                        <th>配比(%)</th>
                    </tr>
                `;
            }
            
            tbody.innerHTML = '';
            
            if (currentResults.beanComposition && currentResults.beanComposition.length > 0) {
                currentResults.beanComposition.forEach(bean => {
                    const row = document.createElement('tr');
                    if (hideBeanPrice) {
                        row.innerHTML = `
                            <td>${bean.name}</td>
                            <td>${bean.ratio}</td>
                        `;
                    } else {
                        row.innerHTML = `
                            <td>${bean.name}</td>
                            <td>${bean.price.toFixed(2)}</td>
                            <td>${bean.ratio}</td>
                        `;
                    }
                    tbody.appendChild(row);
                });
            }
            
            // 更新备注信息
            const remarkContainer = document.getElementById('img-remark-container');
            const remarkText = document.getElementById('img-remark-text');
            
            if (remark.trim()) {
                remarkContainer.style.display = 'block';
                remarkText.textContent = remark;
            } else {
                remarkContainer.style.display = 'none';
            }
            
            // 更新生成时间
            const generationTime = new Date().toLocaleString('zh-CN');
            document.getElementById('img-generation-time').textContent = generationTime;
            
            // 显示隐藏的表格容器
            const tableContainer = document.getElementById('table-for-image');
            tableContainer.style.display = 'block';
            
            // 使用html2canvas生成图片
            html2canvas(tableContainer, {
                backgroundColor: '#ffffff',
                scale: 2, // 提高图片清晰度
                useCORS: true
            }).then(canvas => {
                // 将canvas转换为图片URL
                const imgData = canvas.toDataURL('image/png');
                
                // 创建一个临时链接用于下载
                const link = document.createElement('a');
                const fileName = currentResults.productName ? 
                    `咖啡豆产品信息_${currentResults.productName}_${new Date().toISOString().slice(0, 10)}.png` :
                    `咖啡豆产品信息_${new Date().toISOString().slice(0, 10)}.png`;
                link.download = fileName;
                link.href = imgData;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 隐藏表格容器
                tableContainer.style.display = 'none';
                
                alert("表格图片已生成并下载！");
            }).catch(error => {
                console.error("生成图片时出错：", error);
                alert("生成图片时出错，请稍后再试。");
                tableContainer.style.display = 'none';
            });
        }
        
        // 加载历史记录
        function loadHistory() {
            const tbody = document.getElementById('history-tbody');
            const noHistory = document.getElementById('no-history');
            
            if (history.length === 0) {
                tbody.innerHTML = '';
                noHistory.style.display = 'block';
                return;
            }
            
            tbody.innerHTML = '';
            noHistory.style.display = 'none';
            
            history.forEach(record => {
                // 生成生豆构成描述
                let beanDescription = '';
                if (record.beanComposition && record.beanComposition.length > 0) {
                    beanDescription = record.beanComposition.map(bean => 
                        `${bean.name || ''}: ${bean.ratio || 0}% (${bean.price || 0}元/kg)`
                    ).join('; ');
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.productName || '咖啡豆产品'}</td>
                    <td>${record.businessOwner || ''}</td>
                    <td style="max-width: 200px; text-align: left; font-size: 12px;">${beanDescription}</td>
                    <td>${record.rawBeanCost.toFixed(2)}</td>
                    <td>${record.packagingCost.toFixed(4)}</td>
                    <td>${record.recommendedPrice.toFixed(2)}</td>
                    <td>${record.targetMargin.toFixed(2)}%</td>
                    <td>${record.timestamp}</td>
                    <td>
                        <div class="history-actions-cell">
                            <button class="restore-btn history-action-btn" data-id="${record.id}" style="background-color: #FF9800;">调回</button>
                            <button class="remove-history-btn history-action-btn" data-id="${record.id}" style="background-color: #f44336;">删除</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 添加调回按钮事件监听器
            document.querySelectorAll('.restore-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    restoreHistoryRecord(id);
                });
            });
            
            // 添加删除按钮事件监听器
            document.querySelectorAll('.remove-history-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    removeHistoryRecord(id);
                });
            });
        }
        
        // 从历史记录调回
        function restoreHistoryRecord(id) {
            const record = history.find(r => r.id === id);
            if (!record) {
                alert("未找到对应的历史记录！");
                return;
            }
            
            restoreFromHistory(record);
        }
        
        // 删除历史记录
        function removeHistoryRecord(id) {
            if (confirm("确定要删除这条历史记录吗？")) {
                history = history.filter(record => record.id !== id);
                localStorage.setItem('coffee_bean_history', JSON.stringify(history));
                loadHistory();
            }
        }
        
        // 清空历史记录
        function clearHistory() {
            if (history.length === 0) {
                alert("历史记录已为空！");
                return;
            }
            
            if (confirm("确定要清空所有历史记录吗？此操作不可撤销！")) {
                history = [];
                localStorage.setItem('coffee_bean_history', JSON.stringify(history));
                loadHistory();
                alert("历史记录已清空！");
            }
        }
        
        // 导出历史记录为Excel
        function exportHistoryToExcel() {
            if (history.length === 0) {
                alert("没有历史记录可导出！");
                return;
            }
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建主工作表数据
            const mainData = [
                ['产品名称', '业务归属', '生豆平均成本(元/kg)', '熟豆成本(元/袋)', '包材成本(元/袋)', 
                 '熟豆烘焙能耗(元/袋)', '包装人工(元/袋)', '运输成本(元/袋)', 
                 '不含能耗和人工成本(元/袋)', '含能耗和人工成本(元/袋)', 
                 '目标毛利率(%)', '对外报价(元/袋)', '每袋税后毛利(元)', 
                 '每公斤税后毛利(元)', '税后毛利率(%)', 
                 '进项税合计(元/袋)', '销项税(元/袋)', '实际增值税成本(元/袋)', '保存时间']
            ];
            
            // 创建生豆构成工作表数据
            const beanData = [
                ['产品名称', '业务归属', '保存时间', '生豆名称', '单价(元/公斤)', '配比(%)']
            ];
            
            // 创建输入参数工作表数据
            const inputData = [
                ['产品名称', '业务归属', '保存时间', '包装规格(g/袋)', '生转熟损耗率', '每箱装袋数', 
                 '包袋成本(元/袋)', '贴纸成本(元/袋)', '纸箱成本(元/箱)', 
                 '生豆烘焙能耗(元/公斤)', '包装人工费(元/袋)', '运费单价(元/公斤)', 
                 '对外开票税率(%)', '目标毛利率(%)', '对外报价(元/袋)', '计算模式']
            ];
            
            // 填充数据
            history.forEach(record => {
                // 主工作表数据
                mainData.push([
                    record.productName || '',
                    record.businessOwner || '',
                    record.rawBeanCost.toFixed(2),
                    record.roastedBeanCostPerBag.toFixed(4),
                    record.packagingCost.toFixed(4),
                    record.energyCostPerBag.toFixed(4),
                    record.packagingLabor.toFixed(3),
                    record.transportCostPerBag.toFixed(4),
                    record.costWithoutEnergyLabor.toFixed(4),
                    record.costWithEnergyLabor.toFixed(4),
                    record.targetMargin.toFixed(2),
                    record.recommendedPrice.toFixed(2),
                    record.profitAfterTax.toFixed(4),
                    record.profitAfterTaxPerKg.toFixed(2),
                    record.profitMarginAfterTax.toFixed(2),
                    record.totalInputVat.toFixed(4),
                    record.outputVat.toFixed(4),
                    record.actualVatCost.toFixed(4),
                    record.timestamp
                ]);
                
                // 生豆构成工作表数据
                if (record.beanComposition && record.beanComposition.length > 0) {
                    record.beanComposition.forEach(bean => {
                        beanData.push([
                            record.productName || '',
                            record.businessOwner || '',
                            record.timestamp,
                            bean.name || '',
                            bean.price || 0,
                            bean.ratio || 0
                        ]);
                    });
                }
                
                // 输入参数工作表数据
                if (record.inputParams) {
                    inputData.push([
                        record.productName || '',
                        record.businessOwner || '',
                        record.timestamp,
                        record.inputParams.packageWeight || 0,
                        record.inputParams.roastingLoss || 0,
                        record.inputParams.bagsPerBox || 0,
                        record.inputParams.bagCost || 0,
                        record.inputParams.stickerCost || 0,
                        record.inputParams.boxCost || 0,
                        record.inputParams.rawBeanEnergyCost || 0,
                        record.inputParams.packagingLabor || 0,
                        record.inputParams.transportCost || 0,
                        record.inputParams.vatRate || 0,
                        record.inputParams.targetMargin || 0,
                        record.inputParams.externalPrice || 0,
                        record.inputParams.calculationMode || ''
                    ]);
                }
            });
            
            // 创建工作表
            const mainWs = XLSX.utils.aoa_to_sheet(mainData);
            const beanWs = XLSX.utils.aoa_to_sheet(beanData);
            const inputWs = XLSX.utils.aoa_to_sheet(inputData);
            
            // 设置列宽
            const mainColWidths = [
                {wch: 20}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}, 
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 15}, 
                {wch: 10}, {wch: 12}, {wch: 12}, {wch: 12}, 
                {wch: 10}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 20}
            ];
            mainWs['!cols'] = mainColWidths;
            
            const beanColWidths = [
                {wch: 20}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 12}, {wch: 8}
            ];
            beanWs['!cols'] = beanColWidths;
            
            const inputColWidths = [
                {wch: 20}, {wch: 15}, {wch: 20}, {wch: 12}, {wch: 12}, {wch: 10}, 
                {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}, 
                {wch: 12}, {wch: 12}, {wch: 10}, {wch: 10}, 
                {wch: 12}, {wch: 12}
            ];
            inputWs['!cols'] = inputColWidths;
            
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, mainWs, "历史记录主表");
            XLSX.utils.book_append_sheet(wb, beanWs, "生豆构成明细");
            XLSX.utils.book_append_sheet(wb, inputWs, "输入参数明细");
            
            // 生成文件名
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const fileName = `咖啡豆核价历史记录_${timestamp}.xlsx`;
            
            // 下载Excel文件
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>